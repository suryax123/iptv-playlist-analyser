const urlInput = document.getElementById('playlistUrl');const clearBtn = document.getElementById('clearBtn');const actionBtn = document.getElementById('actionBtn');const actionBtnText = document.getElementById('actionBtnText');const loadingText = document.getElementById('loadingText');const httpWarning = document.getElementById('httpWarning');const statusContainer = document.getElementById('statusContainer');const statusCard = document.getElementById('statusCard');const analysisProgress = document.getElementById('analysisProgress');const analysisProgressBar = document.getElementById('analysisProgressBar');const progressCount = document.getElementById('progressCount');const analysisResults = document.getElementById('analysisResults');const convertResults = document.getElementById('convertResults');const modeBtns = document.querySelectorAll('.mode-btn');const filterBtns = document.querySelectorAll('.filter-btn');let currentMode = 'analyze';let currentAnalysis = null;let currentPlaylistContent = null;let currentPlaylistUrl = null;let displayedChannels = 20;let jsPDFLoaded = false;const MAX_URL_LENGTH = 2048;const ALLOWED_PROTOCOLS =['http:','https:'];function init(){setupEventListeners();updateModeUI();}function setupEventListeners(){urlInput.addEventListener('input',debounce(handleInputChange,150));urlInput.addEventListener('keypress',handleKeyPress);urlInput.addEventListener('paste',handlePaste);clearBtn.addEventListener('click',clearInput);actionBtn.addEventListener('click',handleAction);modeBtns.forEach(btn =>{btn.addEventListener('click',()=> switchMode(btn.dataset.mode));});filterBtns.forEach(btn =>{btn.addEventListener('click',()=> filterChannels(btn.dataset.filter));});document.getElementById('downloadReportBtn')?.addEventListener('click',downloadReport);document.getElementById('newAnalysisBtn')?.addEventListener('click',resetForNew);document.getElementById('downloadPdfBtn')?.addEventListener('click',downloadPdf);document.getElementById('convertAnotherBtn')?.addEventListener('click',resetForNew);document.getElementById('showMoreBtn')?.addEventListener('click',showMoreChannels);document.getElementById('checkAnotherBtn')?.addEventListener('click',resetForNew);}function debounce(func,wait){let timeout;return function executedFunction(...args){const later =()=>{clearTimeout(timeout);func(...args);};clearTimeout(timeout);timeout = setTimeout(later,wait);};}function isValidUrl(url){if(!url || typeof url !== 'string')return false;if(url.length > MAX_URL_LENGTH)return false;try{const parsed = new URL(url);return ALLOWED_PROTOCOLS.includes(parsed.protocol);}catch{return false;}}function sanitizeUrl(url){if(!url)return '';return url.replace(/[<>"'&]/g, '');}function escapeHtml(text){if(!text)return '';const div = document.createElement('div');div.textContent = String(text).substring(0,1000);return div.innerHTML;}function formatBytes(bytes){if(bytes === 0)return '0 Bytes';const k = 1024;const sizes =['Bytes','KB','MB'];const i = Math.floor(Math.log(bytes)/ Math.log(k));return parseFloat((bytes / Math.pow(k,i)).toFixed(2))+ ' ' + sizes[i];}async function loadJsPDF(){if(jsPDFLoaded)return true;return new Promise((resolve,reject)=>{const script = document.createElement('script');script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';script.onload =()=>{jsPDFLoaded = true;resolve(true);};script.onerror =()=> reject(new Error('Failed to load PDF library'));document.head.appendChild(script);});}async function generatePlaylistPDF(content,sourceUrl){await loadJsPDF();const{jsPDF}= window.jspdf;const doc = new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});const pageWidth = doc.internal.pageSize.getWidth();const pageHeight = doc.internal.pageSize.getHeight();const margin = 15;const lineHeight = 4;let y = margin;doc.setFillColor(26,26,46);doc.rect(0,0,pageWidth,30,'F');doc.setTextColor(255,255,255);doc.setFontSize(18);doc.setFont('helvetica','bold');doc.text('IPTV Playlist',margin,15);doc.setFontSize(8);doc.setFont('helvetica','normal');doc.setTextColor(136,136,136);doc.text(`Generated: ${new Date().toLocaleString()}`,margin,22);doc.text(`Source: ${sanitizeUrl(sourceUrl).substring(0, 60)}...`,margin,26);y = 40;const lines = content.split('\n');doc.setFontSize(7);for(const line of lines){if(y > pageHeight - margin){doc.addPage();y = margin;}const trimmedLine = line.replace(/\r/g,'').substring(0,200);if(trimmedLine.startsWith('#EXTM3U')|| trimmedLine.startsWith('#EXT')){doc.setTextColor(99,102,241);}else if(trimmedLine.startsWith('http')){doc.setTextColor(16,185,129);}else{doc.setTextColor(51,51,51);}if(trimmedLine.length > 0){doc.setFont('courier','normal');doc.text(trimmedLine,margin,y);y += lineHeight;}else{y += 2;}}return doc;}async function generateAnalysisReportPDF(analysis){await loadJsPDF();const{jsPDF}= window.jspdf;const doc = new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});const pageWidth = doc.internal.pageSize.getWidth();const pageHeight = doc.internal.pageSize.getHeight();const margin = 15;let y = margin;doc.setFillColor(26,26,46);doc.rect(0,0,pageWidth,35,'F');doc.setTextColor(255,255,255);doc.setFontSize(20);doc.setFont('helvetica','bold');doc.text('Playlist Analysis Report',margin,15);doc.setFontSize(8);doc.setFont('helvetica','normal');doc.setTextColor(167,139,250);doc.text(`Generated: ${new Date().toLocaleString()}`,margin,24);doc.setTextColor(136,136,136);doc.text(`Source: ${sanitizeUrl(analysis.url || '').substring(0, 70)}...`,margin,30);y = 45;doc.setTextColor(139,92,246);doc.setFontSize(14);doc.setFont('helvetica','bold');doc.text('Summary',margin,y);y += 10;const summary = analysis.summary;const summaryItems =[['Total Channels:',summary.totalChannels],['Checked Channels:',summary.checkedChannels],['Live Channels:',`${summary.liveChannels} (${summary.livePercentage}%)`],['Dead Channels:',summary.deadChannels],['Avg Response Time:',`${summary.avgResponseTime}ms`],['Categories/Groups:',summary.groupCount]];doc.setFontSize(10);summaryItems.forEach(([label,value])=>{doc.setFont('helvetica','bold');doc.setTextColor(51,51,51);doc.text(label,margin,y);doc.setFont('helvetica','normal');doc.setTextColor(102,102,102);doc.text(String(value),margin + 45,y);y += 6;});y += 10;if(analysis.groups && analysis.groups.length > 0){doc.setTextColor(139,92,246);doc.setFontSize(14);doc.setFont('helvetica','bold');doc.text('Categories/Groups',margin,y);y += 8;doc.setFontSize(9);doc.setFont('helvetica','normal');analysis.groups.slice(0,15).forEach(group =>{if(y > pageHeight - 20){doc.addPage();y = margin;}doc.setTextColor(51,51,51);doc.text(`• ${escapeHtml(group.name)}: ${group.count} channels`,margin,y);y += 5;});y += 10;}if(analysis.channels && analysis.channels.length > 0){doc.addPage();y = margin;doc.setTextColor(139,92,246);doc.setFontSize(14);doc.setFont('helvetica','bold');doc.text('Channel Details',margin,y);y += 10;doc.setFontSize(8);analysis.channels.slice(0,100).forEach((channel,index)=>{if(y > pageHeight - 25){doc.addPage();y = margin;}const statusColor = channel.status === 'live' ?[16,185,129]:channel.status === 'dead' ?[239,68,68]:[136,136,136];doc.setFillColor(...statusColor);doc.circle(margin + 2,y - 1,2,'F');doc.setFont('helvetica','bold');doc.setTextColor(51,51,51);doc.text(`${index + 1}. ${escapeHtml(channel.name || 'Unknown').substring(0, 50)}`,margin + 6,y);y += 4;doc.setFont('helvetica','normal');doc.setTextColor(102,102,102);doc.setFontSize(7);let details = `Group: ${escapeHtml(channel.group || 'N/A')} | Status: ${channel.status.toUpperCase()}`;if(channel.responseTime){details += ` | ${channel.responseTime}ms`;}doc.text(details,margin + 6,y);y += 6;doc.setFontSize(8);});}const pageCount = doc.internal.getNumberOfPages();for(let i = 1;i <= pageCount;i++){doc.setPage(i);doc.setFontSize(8);doc.setTextColor(136,136,136);doc.text(`Page ${i} of ${pageCount}`,pageWidth / 2,pageHeight - 10,{align:'center'});}return doc;}function switchMode(mode){currentMode = mode;modeBtns.forEach(btn =>{btn.classList.toggle('active',btn.dataset.mode === mode);});updateModeUI();resetState();}function updateModeUI(){const placeholder = urlInput;const actionBtnIcon = document.getElementById('actionBtnIcon');if(currentMode === 'analyze'){actionBtnText.textContent = 'Analyze Playlist';loadingText.textContent = 'Analyzing...';placeholder.placeholder = 'Paste your playlist URL here (HTTP or HTTPS)...';if(actionBtnIcon){actionBtnIcon.innerHTML = ` <circle cx="11" cy="11" r="8"/> <path d="M21 21l-4.35-4.35"/> <path d="M11 8v6"/> <path d="M8 11h6"/> `;}}else if(currentMode === 'channel'){actionBtnText.textContent = 'Check Channel';loadingText.textContent = 'Checking...';placeholder.placeholder = 'Paste channel/stream URL (e.g., .m3u8, .ts)...';if(actionBtnIcon){actionBtnIcon.innerHTML = ` <polygon points="5 3 19 12 5 21 5 3"/> `;}}else{actionBtnText.textContent = 'Convert to PDF';loadingText.textContent = 'Converting...';placeholder.placeholder = 'Paste your playlist URL here (HTTP or HTTPS)...';if(actionBtnIcon){actionBtnIcon.innerHTML = ` <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/> <polyline points="14 2 14 8 20 8"/> <line x1="16" y1="13" x2="8" y2="13"/> <line x1="16" y1="17" x2="8" y2="17"/> `;}}}function handleInputChange(){const value = urlInput.value.trim();clearBtn.classList.toggle('hidden',!value);if(value.toLowerCase().startsWith('http://')){httpWarning.classList.remove('hidden');}else{httpWarning.classList.add('hidden');}if(statusCard?.classList.contains('error')){hideStatus();}}function handleKeyPress(e){if(e.key === 'Enter' && !actionBtn.disabled){handleAction();}}function handlePaste(e){setTimeout(()=>{if(urlInput.value.length > MAX_URL_LENGTH){urlInput.value = urlInput.value.substring(0,MAX_URL_LENGTH);showStatus('Warning','URL was truncated to maximum allowed length','error');}},0);}function clearInput(){urlInput.value = '';clearBtn.classList.add('hidden');httpWarning.classList.add('hidden');hideStatus();}async function handleAction(){const url = urlInput.value.trim();if(!url){showStatus('Missing URL','Please enter a URL','error');return;}if(!isValidUrl(url)){showStatus('Invalid URL','Please enter a valid URL starting with http:// or https://','error');return;}if(currentMode === 'analyze'){await analyzePlaylist(url);}else if(currentMode === 'channel'){await checkChannel(url);}else{await convertPlaylist(url);}}async function checkChannel(url){resetState();setLoading(true);if(url.toLowerCase().startsWith('http://')){httpWarning.classList.remove('hidden');}try{showStatus('Checking channel...','Testing stream accessibility','info');const response = await fetch('/api/check-channel',{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify({url:sanitizeUrl(url)})});const responseText = await response.text();let data;try{data = JSON.parse(responseText);}catch(parseError){throw new Error('Server returned an invalid response');}if(!response.ok){throw new Error(data.error || 'Check failed');}hideStatus();displayChannelResults(data,url);}catch(error){console.error('Channel check error:',error);showStatus('Error',error.message || 'Channel check failed','error');}finally{setLoading(false);}}function displayChannelResults(result,url){const channelResults = document.getElementById('channelResults');const statusIcon = document.getElementById('channelStatusIcon');const statusText = document.getElementById('channelStatusText');const channelUrl = document.getElementById('channelUrl');const detailStatus = document.getElementById('detailStatus');const detailHttpCode = document.getElementById('detailHttpCode');const detailResponseTime = document.getElementById('detailResponseTime');const detailContentType = document.getElementById('detailContentType');const detailUrlValid = document.getElementById('detailUrlValid');const detailProtocol = document.getElementById('detailProtocol');const detailStreamType = document.getElementById('detailStreamType');const detailServer = document.getElementById('detailServer');const isLive = result.status === 'live';statusIcon.className = `channel-status-large ${isLive ? 'live' : 'dead'}`;statusIcon.innerHTML = isLive ? `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"> <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/> <polyline points="22 4 12 14.01 9 11.01"/> </svg>`:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"> <circle cx="12" cy="12" r="10"/> <line x1="15" y1="9" x2="9" y2="15"/> <line x1="9" y1="9" x2="15" y2="15"/> </svg>`;statusText.textContent = isLive ? 'Stream is LIVE':'Stream is DEAD';statusText.className = isLive ? 'live':'dead';channelUrl.textContent = url.length > 80 ? url.substring(0,80)+ '...':url;detailStatus.textContent = result.status.toUpperCase();detailStatus.className = `detail-value ${isLive ? 'live' : 'dead'}`;detailHttpCode.textContent = result.httpStatus || '-';const responseTime = result.responseTime || 0;detailResponseTime.textContent = `${responseTime}ms`;detailResponseTime.className = `detail-value ${getResponseClass(responseTime)}`;detailContentType.textContent = result.contentType ?(result.contentType.split(';')[0]|| '-'):'-';if(detailUrlValid){detailUrlValid.textContent = result.urlValid ? '✓ Valid':'✗ Invalid';detailUrlValid.className = `detail-value ${result.urlValid ? 'live' : 'dead'}`;}if(detailProtocol){detailProtocol.textContent = result.protocol || '-';detailProtocol.className = `detail-value ${result.protocol === 'HTTPS' ? 'live' : ''}`;}if(detailStreamType){detailStreamType.textContent = result.streamType || '-';}if(detailServer){const server = result.server || '-';detailServer.textContent = server.length > 25 ? server.substring(0,25)+ '...':server;}channelResults.classList.remove('hidden');channelResults.scrollIntoView({behavior:'smooth',block:'start'});}async function analyzePlaylist(url){resetState();setLoading(true);if(url.toLowerCase().startsWith('http://')){httpWarning.classList.remove('hidden');}try{showStatus('Fetching playlist...','Downloading and parsing playlist content','info');analysisProgress.classList.remove('hidden');analysisProgressBar.style.width = '10%';const response = await fetch('/api/analyze',{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify({url:sanitizeUrl(url),checkChannels:true,maxChannelsToCheck:50})});const responseText = await response.text();let data;try{data = JSON.parse(responseText);}catch(parseError){console.error('Response was not JSON:',responseText.substring(0,200));throw new Error('Server returned an invalid response. Please try again.');}if(!response.ok){throw new Error(data.error || 'Analysis failed');}analysisProgressBar.style.width = '100%';currentAnalysis = data;currentPlaylistUrl = url;analysisProgress.classList.add('hidden');hideStatus();displayAnalysisResults(data);}catch(error){console.error('Analysis error:',error);showStatus('Error',error.message || 'Analysis failed','error');analysisProgress.classList.add('hidden');}finally{setLoading(false);}}async function convertPlaylist(url){resetState();setLoading(true);if(url.toLowerCase().startsWith('http://')){httpWarning.classList.remove('hidden');}try{showStatus('Fetching playlist...','Downloading content','info');const response = await fetch('/api/fetch-playlist',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url:sanitizeUrl(url)})});if(!response.ok){const errorData = await response.json().catch(()=>({error:'Fetch failed'}));throw new Error(errorData.error || 'Failed to fetch playlist');}const data = await response.json();currentPlaylistContent = data.content;currentPlaylistUrl = url;showStatus('Generating PDF...','Creating document in your browser','info');const doc = await generatePlaylistPDF(data.content,url);currentPlaylistContent = data.content;hideStatus();convertResults.classList.remove('hidden');}catch(error){console.error('Conversion error:',error);showStatus('Error',error.message || 'Conversion failed','error');}finally{setLoading(false);}}function displayAnalysisResults(analysis){analysisResults.classList.remove('hidden');const summary = analysis.summary;document.getElementById('totalChannels').textContent = summary.totalChannels;document.getElementById('liveChannels').textContent = summary.liveChannels;document.getElementById('deadChannels').textContent = summary.deadChannels;document.getElementById('groupCount').textContent = summary.groupCount;document.getElementById('livePercentage').textContent = `${summary.livePercentage}%`;const checkedTotal = summary.checkedChannels;const livePercent = checkedTotal > 0 ?(summary.liveChannels / checkedTotal)* 100:0;const deadPercent = checkedTotal > 0 ?(summary.deadChannels / checkedTotal)* 100:0;document.getElementById('liveBar').style.width = `${livePercent}%`;document.getElementById('deadBar').style.width = `${deadPercent}%`;const categoriesGrid = document.getElementById('categoriesGrid');categoriesGrid.innerHTML = analysis.groups.slice(0,12).map(group => ` <span class="category-tag"> ${escapeHtml(group.name)}<span class="count">${group.count}</span> </span> `).join('');if(analysis.groups.length > 12){categoriesGrid.innerHTML += `<span class="category-tag">+${analysis.groups.length - 12} more</span>`;}displayedChannels = 20;renderChannels(analysis.channels,'all');analysisResults.scrollIntoView({behavior:'smooth',block:'start'});}function renderChannels(channels,filter){const channelsList = document.getElementById('channelsList');const showMoreContainer = document.getElementById('showMoreContainer');let filtered = channels;if(filter === 'live'){filtered = channels.filter(c => c.status === 'live');}else if(filter === 'dead'){filtered = channels.filter(c => c.status === 'dead');}document.getElementById('channelListCount').textContent = `(${filtered.length})`;const toShow = filtered.slice(0,displayedChannels);channelsList.innerHTML = toShow.map((channel,index)=>{const responseClass = getResponseClass(channel.responseTime);return ` <div class="channel-item" data-status="${escapeHtml(channel.status)}"> <div class="channel-status ${escapeHtml(channel.status)}"></div> <div class="channel-info"> <div class="channel-name">${escapeHtml(channel.name || 'Unknown')}</div> <div class="channel-meta">${escapeHtml(channel.group || 'Uncategorized')}</div> </div> ${channel.responseTime ? `<div class="channel-response ${responseClass}">${channel.responseTime}ms</div>`:''}</div> `;}).join('');if(filtered.length > displayedChannels){showMoreContainer.classList.remove('hidden');}else{showMoreContainer.classList.add('hidden');}}function filterChannels(filter){filterBtns.forEach(btn =>{btn.classList.toggle('active',btn.dataset.filter === filter);});if(currentAnalysis){displayedChannels = 20;renderChannels(currentAnalysis.channels,filter);}}function showMoreChannels(){displayedChannels += 20;const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';if(currentAnalysis){renderChannels(currentAnalysis.channels,activeFilter);}}function getResponseClass(ms){if(!ms)return '';if(ms < 500)return 'fast';if(ms < 2000)return 'medium';return 'slow';}async function downloadReport(){if(!currentAnalysis)return;try{showStatus('Generating PDF...','Creating report in your browser','info');const doc = await generateAnalysisReportPDF(currentAnalysis);doc.save(`analysis_report_${Date.now()}.pdf`);hideStatus();showStatus('Success','Report downloaded successfully','success');setTimeout(hideStatus,3000);}catch(error){showStatus('Error','Failed to generate report: ' + error.message,'error');}}async function downloadPdf(){if(!currentPlaylistContent)return;try{showStatus('Generating PDF...','Creating document','info');const doc = await generatePlaylistPDF(currentPlaylistContent,currentPlaylistUrl);doc.save(`playlist_${Date.now()}.pdf`);hideStatus();showStatus('Success','PDF downloaded successfully','success');setTimeout(hideStatus,3000);}catch(error){showStatus('Error','Failed to generate PDF: ' + error.message,'error');}}function showStatus(title,message,type = 'info'){statusContainer.classList.remove('hidden');statusCard.className = 'status-card ' + type;const statusIcon = statusCard.querySelector('.status-icon');const statusTitle = statusCard.querySelector('.status-title');const statusMessage = statusCard.querySelector('.status-message');let iconSvg = '';if(type === 'error'){iconSvg = `<svg viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" width="20" height="20"> <circle cx="12" cy="12" r="10"/> <line x1="15" y1="9" x2="9" y2="15"/> <line x1="9" y1="9" x2="15" y2="15"/> </svg>`;}else if(type === 'success'){iconSvg = `<svg viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" width="20" height="20"> <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/> <polyline points="22 4 12 14.01 9 11.01"/> </svg>`;}else{iconSvg = `<svg viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2" width="20" height="20"> <circle cx="12" cy="12" r="10"/> <polyline points="12 6 12 12 16 14"/> </svg>`;}statusIcon.innerHTML = iconSvg;statusTitle.textContent = title;statusMessage.textContent = message;}function hideStatus(){statusContainer.classList.add('hidden');}function setLoading(loading){if(loading){actionBtn.classList.add('loading');actionBtn.disabled = true;urlInput.disabled = true;}else{actionBtn.classList.remove('loading');actionBtn.disabled = false;urlInput.disabled = false;}}function resetState(){hideStatus();analysisProgress.classList.add('hidden');analysisResults.classList.add('hidden');convertResults.classList.add('hidden');document.getElementById('channelResults')?.classList.add('hidden');analysisProgressBar.style.width = '0%';currentAnalysis = null;currentPlaylistContent = null;displayedChannels = 20;}function resetForNew(){urlInput.value = '';clearBtn.classList.add('hidden');httpWarning.classList.add('hidden');resetState();urlInput.focus();window.scrollTo({top:0,behavior:'smooth'});}document.addEventListener('DOMContentLoaded',init);